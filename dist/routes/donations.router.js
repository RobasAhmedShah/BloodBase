"use strict";
/*
 * SPDX-License-Identifier: Apache-2.0
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.donationsRouter = void 0;
const express_1 = __importDefault(require("express"));
const express_validator_1 = require("express-validator");
const http_status_codes_1 = require("http-status-codes");
const fabric_1 = require("../fabric");
const { OK, CREATED, BAD_REQUEST, NOT_FOUND, INTERNAL_SERVER_ERROR } = http_status_codes_1.StatusCodes;
exports.donationsRouter = express_1.default.Router();
/**
 * Get all donations
 */
exports.donationsRouter.get('/', async (req, res) => {
    console.log('Get all donations request received');
    try {
        const contract = req.app.locals.contract;
        const result = await (0, fabric_1.evaluateTransaction)(contract, 'GetAllDonations');
        const donations = JSON.parse(Buffer.from(result).toString());
        return res.status(OK).json(donations);
    }
    catch (error) {
        console.error('Error getting all donations:', error);
        return res.status(INTERNAL_SERVER_ERROR).json({
            status: 'Internal Server Error',
            message: error?.message || 'Unknown error',
            timestamp: new Date().toISOString()
        });
    }
});
/**
 * Create a new donation
 */
exports.donationsRouter.post('/', [
    (0, express_validator_1.body)('id').isString().notEmpty().withMessage('Donation ID is required'),
    (0, express_validator_1.body)('donorID').isString().notEmpty().withMessage('Donor ID is required'),
    (0, express_validator_1.body)('bloodType').isString().notEmpty().withMessage('Blood type is required'),
    (0, express_validator_1.body)('timestamp').isString().notEmpty().withMessage('Timestamp is required')
], async (req, res) => {
    console.log('Create donation request received:', req.body);
    // Validate request
    const errors = (0, express_validator_1.validationResult)(req);
    if (!errors.isEmpty()) {
        return res.status(BAD_REQUEST).json({
            status: 'Bad Request',
            errors: errors.array(),
            timestamp: new Date().toISOString()
        });
    }
    try {
        const contract = req.app.locals.contract;
        const { id, donorID, bloodType, timestamp } = req.body;
        // Check if donation already exists
        try {
            const existsResult = await (0, fabric_1.evaluateTransaction)(contract, 'DonationExists', id);
            const exists = Buffer.from(existsResult).toString() === 'true';
            if (exists) {
                return res.status(BAD_REQUEST).json({
                    status: 'Bad Request',
                    message: `Donation with ID ${id} already exists`,
                    timestamp: new Date().toISOString()
                });
            }
        }
        catch (checkError) {
            console.error('Error checking if donation exists:', checkError);
            // Continue if error occurs during existence check
        }
        // Create the donation
        await (0, fabric_1.submitTransaction)(contract, 'CreateDonation', id, donorID, bloodType, timestamp);
        return res.status(CREATED).json({
            status: 'Created',
            message: 'Donation created successfully',
            id,
            timestamp: new Date().toISOString()
        });
    }
    catch (error) {
        console.error('Error creating donation:', error);
        return res.status(INTERNAL_SERVER_ERROR).json({
            status: 'Internal Server Error',
            message: error?.message || 'Unknown error',
            timestamp: new Date().toISOString()
        });
    }
});
/**
 * Get a specific donation by ID
 */
exports.donationsRouter.get('/:id', [
    (0, express_validator_1.param)('id').isString().notEmpty().withMessage('Donation ID is required')
], async (req, res) => {
    console.log(`Get donation request received for ID: ${req.params.id}`);
    const errors = (0, express_validator_1.validationResult)(req);
    if (!errors.isEmpty()) {
        return res.status(BAD_REQUEST).json({
            status: 'Bad Request',
            errors: errors.array(),
            timestamp: new Date().toISOString()
        });
    }
    try {
        const contract = req.app.locals.contract;
        const id = req.params.id;
        try {
            const result = await (0, fabric_1.evaluateTransaction)(contract, 'ReadDonation', id);
            const donation = JSON.parse(Buffer.from(result).toString());
            return res.status(OK).json(donation);
        }
        catch (readError) {
            // Check if donation not found
            if (readError?.message && readError.message.includes('does not exist')) {
                return res.status(NOT_FOUND).json({
                    status: 'Not Found',
                    message: `Donation with ID ${id} not found`,
                    timestamp: new Date().toISOString()
                });
            }
            throw readError;
        }
    }
    catch (error) {
        console.error(`Error getting donation with ID ${req.params.id}:`, error);
        return res.status(INTERNAL_SERVER_ERROR).json({
            status: 'Internal Server Error',
            message: error?.message || 'Unknown error',
            timestamp: new Date().toISOString()
        });
    }
});
/**
 * Update donation status
 */
exports.donationsRouter.put('/:id/status', [
    (0, express_validator_1.param)('id').isString().notEmpty().withMessage('Donation ID is required'),
    (0, express_validator_1.body)('status').isString().notEmpty().withMessage('Status is required')
], async (req, res) => {
    console.log(`Update donation status request received for ID: ${req.params.id}`);
    const errors = (0, express_validator_1.validationResult)(req);
    if (!errors.isEmpty()) {
        return res.status(BAD_REQUEST).json({
            status: 'Bad Request',
            errors: errors.array(),
            timestamp: new Date().toISOString()
        });
    }
    try {
        const contract = req.app.locals.contract;
        const id = req.params.id;
        const { status } = req.body;
        // Check if donation exists first
        try {
            const existsResult = await (0, fabric_1.evaluateTransaction)(contract, 'DonationExists', id);
            const exists = Buffer.from(existsResult).toString() === 'true';
            if (!exists) {
                return res.status(NOT_FOUND).json({
                    status: 'Not Found',
                    message: `Donation with ID ${id} not found`,
                    timestamp: new Date().toISOString()
                });
            }
        }
        catch (checkError) {
            console.error('Error checking if donation exists:', checkError);
            // Continue if error occurs during existence check
        }
        // Update donation status
        await (0, fabric_1.submitTransaction)(contract, 'UpdateDonationStatus', id, status);
        return res.status(OK).json({
            status: 'OK',
            message: `Donation ${id} status updated to ${status}`,
            timestamp: new Date().toISOString()
        });
    }
    catch (error) {
        console.error(`Error updating donation status for ID ${req.params.id}:`, error);
        return res.status(INTERNAL_SERVER_ERROR).json({
            status: 'Internal Server Error',
            message: error?.message || 'Unknown error',
            timestamp: new Date().toISOString()
        });
    }
});
/**
 * Delete a donation
 */
exports.donationsRouter.delete('/:id', [
    (0, express_validator_1.param)('id').isString().notEmpty().withMessage('Donation ID is required')
], async (req, res) => {
    console.log(`Delete donation request received for ID: ${req.params.id}`);
    const errors = (0, express_validator_1.validationResult)(req);
    if (!errors.isEmpty()) {
        return res.status(BAD_REQUEST).json({
            status: 'Bad Request',
            errors: errors.array(),
            timestamp: new Date().toISOString()
        });
    }
    try {
        const contract = req.app.locals.contract;
        const id = req.params.id;
        // Check if donation exists first
        try {
            const existsResult = await (0, fabric_1.evaluateTransaction)(contract, 'DonationExists', id);
            const exists = Buffer.from(existsResult).toString() === 'true';
            if (!exists) {
                return res.status(NOT_FOUND).json({
                    status: 'Not Found',
                    message: `Donation with ID ${id} not found`,
                    timestamp: new Date().toISOString()
                });
            }
        }
        catch (checkError) {
            console.error('Error checking if donation exists:', checkError);
            // Continue if error occurs during existence check
        }
        // Delete the donation
        await (0, fabric_1.submitTransaction)(contract, 'DeleteDonation', id);
        return res.status(OK).json({
            status: 'OK',
            message: `Donation ${id} deleted successfully`,
            timestamp: new Date().toISOString()
        });
    }
    catch (error) {
        console.error(`Error deleting donation with ID ${req.params.id}:`, error);
        return res.status(INTERNAL_SERVER_ERROR).json({
            status: 'Internal Server Error',
            message: error?.message || 'Unknown error',
            timestamp: new Date().toISOString()
        });
    }
});
/**
 * Check if a donation exists
 */
exports.donationsRouter.get('/:id/exists', [
    (0, express_validator_1.param)('id').isString().notEmpty().withMessage('Donation ID is required')
], async (req, res) => {
    console.log(`Check donation exists request received for ID: ${req.params.id}`);
    const errors = (0, express_validator_1.validationResult)(req);
    if (!errors.isEmpty()) {
        return res.status(BAD_REQUEST).json({
            status: 'Bad Request',
            errors: errors.array(),
            timestamp: new Date().toISOString()
        });
    }
    try {
        const contract = req.app.locals.contract;
        const id = req.params.id;
        const existsResult = await (0, fabric_1.evaluateTransaction)(contract, 'DonationExists', id);
        const exists = Buffer.from(existsResult).toString() === 'true';
        return res.status(OK).json({
            status: 'OK',
            exists,
            id,
            timestamp: new Date().toISOString()
        });
    }
    catch (error) {
        console.error(`Error checking if donation exists with ID ${req.params.id}:`, error);
        return res.status(INTERNAL_SERVER_ERROR).json({
            status: 'Internal Server Error',
            message: error?.message || 'Unknown error',
            timestamp: new Date().toISOString()
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9uYXRpb25zLnJvdXRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvZG9uYXRpb25zLnJvdXRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7Ozs7OztBQUVILHNEQUFxRDtBQUNyRCx5REFBa0U7QUFDbEUseURBQWdEO0FBRWhELHNDQUFtRTtBQUVuRSxNQUFNLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLHFCQUFxQixFQUFFLEdBQUcsK0JBQVcsQ0FBQztBQUV0RSxRQUFBLGVBQWUsR0FBRyxpQkFBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRWhEOztHQUVHO0FBQ0gsdUJBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDM0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0lBRWxELElBQUksQ0FBQztRQUNELE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQW9CLENBQUM7UUFFckQsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFBLDRCQUFtQixFQUFDLFFBQVEsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBRTdELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7UUFDbEIsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNyRCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUMsTUFBTSxFQUFFLHVCQUF1QjtZQUMvQixPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sSUFBSSxlQUFlO1lBQzFDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUN0QyxDQUFDLENBQUM7SUFDUCxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSDs7R0FFRztBQUNILHVCQUFlLENBQUMsSUFBSSxDQUNoQixHQUFHLEVBQ0g7SUFDSSxJQUFBLHdCQUFJLEVBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxDQUFDLHlCQUF5QixDQUFDO0lBQ3ZFLElBQUEsd0JBQUksRUFBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLENBQUMsc0JBQXNCLENBQUM7SUFDekUsSUFBQSx3QkFBSSxFQUFDLFdBQVcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDLFdBQVcsQ0FBQyx3QkFBd0IsQ0FBQztJQUM3RSxJQUFBLHdCQUFJLEVBQUMsV0FBVyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDO0NBQy9FLEVBQ0QsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNsQyxPQUFPLENBQUMsR0FBRyxDQUFDLG1DQUFtQyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUUzRCxtQkFBbUI7SUFDbkIsTUFBTSxNQUFNLEdBQUcsSUFBQSxvQ0FBZ0IsRUFBQyxHQUFHLENBQUMsQ0FBQztJQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7UUFDcEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNoQyxNQUFNLEVBQUUsYUFBYTtZQUNyQixNQUFNLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRTtZQUN0QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7U0FDdEMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELElBQUksQ0FBQztRQUNELE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQW9CLENBQUM7UUFDckQsTUFBTSxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFdkQsbUNBQW1DO1FBQ25DLElBQUksQ0FBQztZQUNELE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBQSw0QkFBbUIsRUFBQyxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDL0UsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxNQUFNLENBQUM7WUFDL0QsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDVCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNoQyxNQUFNLEVBQUUsYUFBYTtvQkFDckIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLGlCQUFpQjtvQkFDaEQsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2lCQUN0QyxDQUFDLENBQUM7WUFDUCxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sVUFBZSxFQUFFLENBQUM7WUFDdkIsT0FBTyxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUNoRSxrREFBa0Q7UUFDdEQsQ0FBQztRQUVELHNCQUFzQjtRQUN0QixNQUFNLElBQUEsMEJBQWlCLEVBQUMsUUFBUSxFQUFFLGdCQUFnQixFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXZGLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDNUIsTUFBTSxFQUFFLFNBQVM7WUFDakIsT0FBTyxFQUFFLCtCQUErQjtZQUN4QyxFQUFFO1lBQ0YsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1NBQ3RDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ2xCLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFDLE1BQU0sRUFBRSx1QkFBdUI7WUFDL0IsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLElBQUksZUFBZTtZQUMxQyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7U0FDdEMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztBQUNMLENBQUMsQ0FDSixDQUFDO0FBRUY7O0dBRUc7QUFDSCx1QkFBZSxDQUFDLEdBQUcsQ0FDZixNQUFNLEVBQ047SUFDSSxJQUFBLHlCQUFLLEVBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxDQUFDLHlCQUF5QixDQUFDO0NBQzNFLEVBQ0QsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNsQyxPQUFPLENBQUMsR0FBRyxDQUFDLHlDQUF5QyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFdEUsTUFBTSxNQUFNLEdBQUcsSUFBQSxvQ0FBZ0IsRUFBQyxHQUFHLENBQUMsQ0FBQztJQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7UUFDcEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNoQyxNQUFNLEVBQUUsYUFBYTtZQUNyQixNQUFNLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRTtZQUN0QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7U0FDdEMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELElBQUksQ0FBQztRQUNELE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQW9CLENBQUM7UUFDckQsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFFekIsSUFBSSxDQUFDO1lBQ0QsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFBLDRCQUFtQixFQUFDLFFBQVEsRUFBRSxjQUFjLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDdkUsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFFNUQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN6QyxDQUFDO1FBQUMsT0FBTyxTQUFjLEVBQUUsQ0FBQztZQUN0Qiw4QkFBOEI7WUFDOUIsSUFBSSxTQUFTLEVBQUUsT0FBTyxJQUFJLFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQztnQkFDckUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDOUIsTUFBTSxFQUFFLFdBQVc7b0JBQ25CLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxZQUFZO29CQUMzQyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7aUJBQ3RDLENBQUMsQ0FBQztZQUNQLENBQUM7WUFFRCxNQUFNLFNBQVMsQ0FBQztRQUNwQixDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7UUFDbEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN6RSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUMsTUFBTSxFQUFFLHVCQUF1QjtZQUMvQixPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sSUFBSSxlQUFlO1lBQzFDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUN0QyxDQUFDLENBQUM7SUFDUCxDQUFDO0FBQ0wsQ0FBQyxDQUNKLENBQUM7QUFFRjs7R0FFRztBQUNILHVCQUFlLENBQUMsR0FBRyxDQUNmLGFBQWEsRUFDYjtJQUNJLElBQUEseUJBQUssRUFBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLENBQUMseUJBQXlCLENBQUM7SUFDeEUsSUFBQSx3QkFBSSxFQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQztDQUN6RSxFQUNELEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDbEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtREFBbUQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRWhGLE1BQU0sTUFBTSxHQUFHLElBQUEsb0NBQWdCLEVBQUMsR0FBRyxDQUFDLENBQUM7SUFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDaEMsTUFBTSxFQUFFLGFBQWE7WUFDckIsTUFBTSxFQUFFLE1BQU0sQ0FBQyxLQUFLLEVBQUU7WUFDdEIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1NBQ3RDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxJQUFJLENBQUM7UUFDRCxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFvQixDQUFDO1FBQ3JELE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ3pCLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBRTVCLGlDQUFpQztRQUNqQyxJQUFJLENBQUM7WUFDRCxNQUFNLFlBQVksR0FBRyxNQUFNLElBQUEsNEJBQW1CLEVBQUMsUUFBUSxFQUFFLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQy9FLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsUUFBUSxFQUFFLEtBQUssTUFBTSxDQUFDO1lBQy9ELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDVixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUM5QixNQUFNLEVBQUUsV0FBVztvQkFDbkIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLFlBQVk7b0JBQzNDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtpQkFDdEMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLFVBQWUsRUFBRSxDQUFDO1lBQ3ZCLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDaEUsa0RBQWtEO1FBQ3RELENBQUM7UUFFRCx5QkFBeUI7UUFDekIsTUFBTSxJQUFBLDBCQUFpQixFQUFDLFFBQVEsRUFBRSxzQkFBc0IsRUFBRSxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFdEUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUN2QixNQUFNLEVBQUUsSUFBSTtZQUNaLE9BQU8sRUFBRSxZQUFZLEVBQUUsc0JBQXNCLE1BQU0sRUFBRTtZQUNyRCxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7U0FDdEMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7UUFDbEIsT0FBTyxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoRixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUMsTUFBTSxFQUFFLHVCQUF1QjtZQUMvQixPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sSUFBSSxlQUFlO1lBQzFDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUN0QyxDQUFDLENBQUM7SUFDUCxDQUFDO0FBQ0wsQ0FBQyxDQUNKLENBQUM7QUFFRjs7R0FFRztBQUNILHVCQUFlLENBQUMsTUFBTSxDQUNsQixNQUFNLEVBQ047SUFDSSxJQUFBLHlCQUFLLEVBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxDQUFDLHlCQUF5QixDQUFDO0NBQzNFLEVBQ0QsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtJQUNsQyxPQUFPLENBQUMsR0FBRyxDQUFDLDRDQUE0QyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFekUsTUFBTSxNQUFNLEdBQUcsSUFBQSxvQ0FBZ0IsRUFBQyxHQUFHLENBQUMsQ0FBQztJQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7UUFDcEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNoQyxNQUFNLEVBQUUsYUFBYTtZQUNyQixNQUFNLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRTtZQUN0QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7U0FDdEMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELElBQUksQ0FBQztRQUNELE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQW9CLENBQUM7UUFDckQsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFFekIsaUNBQWlDO1FBQ2pDLElBQUksQ0FBQztZQUNELE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBQSw0QkFBbUIsRUFBQyxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDL0UsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxNQUFNLENBQUM7WUFDL0QsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNWLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzlCLE1BQU0sRUFBRSxXQUFXO29CQUNuQixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsWUFBWTtvQkFDM0MsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2lCQUN0QyxDQUFDLENBQUM7WUFDUCxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sVUFBZSxFQUFFLENBQUM7WUFDdkIsT0FBTyxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUNoRSxrREFBa0Q7UUFDdEQsQ0FBQztRQUVELHNCQUFzQjtRQUN0QixNQUFNLElBQUEsMEJBQWlCLEVBQUMsUUFBUSxFQUFFLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRXhELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDdkIsTUFBTSxFQUFFLElBQUk7WUFDWixPQUFPLEVBQUUsWUFBWSxFQUFFLHVCQUF1QjtZQUM5QyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7U0FDdEMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7UUFDbEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQ0FBbUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMxRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUMsTUFBTSxFQUFFLHVCQUF1QjtZQUMvQixPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sSUFBSSxlQUFlO1lBQzFDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUN0QyxDQUFDLENBQUM7SUFDUCxDQUFDO0FBQ0wsQ0FBQyxDQUNKLENBQUM7QUFFRjs7R0FFRztBQUNILHVCQUFlLENBQUMsR0FBRyxDQUNmLGFBQWEsRUFDYjtJQUNJLElBQUEseUJBQUssRUFBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLENBQUMseUJBQXlCLENBQUM7Q0FDM0UsRUFDRCxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ2xDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0RBQWtELEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUUvRSxNQUFNLE1BQU0sR0FBRyxJQUFBLG9DQUFnQixFQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3JDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztRQUNwQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ2hDLE1BQU0sRUFBRSxhQUFhO1lBQ3JCLE1BQU0sRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFO1lBQ3RCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUN0QyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsSUFBSSxDQUFDO1FBQ0QsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBb0IsQ0FBQztRQUNyRCxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUV6QixNQUFNLFlBQVksR0FBRyxNQUFNLElBQUEsNEJBQW1CLEVBQUMsUUFBUSxFQUFFLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQy9FLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsUUFBUSxFQUFFLEtBQUssTUFBTSxDQUFDO1FBRS9ELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDdkIsTUFBTSxFQUFFLElBQUk7WUFDWixNQUFNO1lBQ04sRUFBRTtZQUNGLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUN0QyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNsQixPQUFPLENBQUMsS0FBSyxDQUFDLDZDQUE2QyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3BGLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUMxQyxNQUFNLEVBQUUsdUJBQXVCO1lBQy9CLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxJQUFJLGVBQWU7WUFDMUMsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1NBQ3RDLENBQUMsQ0FBQztJQUNQLENBQUM7QUFDTCxDQUFDLENBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXHJcbiAqL1xyXG5cclxuaW1wb3J0IGV4cHJlc3MsIHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcclxuaW1wb3J0IHsgYm9keSwgcGFyYW0sIHZhbGlkYXRpb25SZXN1bHQgfSBmcm9tICdleHByZXNzLXZhbGlkYXRvcic7XHJcbmltcG9ydCB7IFN0YXR1c0NvZGVzIH0gZnJvbSAnaHR0cC1zdGF0dXMtY29kZXMnO1xyXG5pbXBvcnQgeyBDb250cmFjdCB9IGZyb20gJ0BoeXBlcmxlZGdlci9mYWJyaWMtZ2F0ZXdheSc7XHJcbmltcG9ydCB7IGV2YWx1YXRlVHJhbnNhY3Rpb24sIHN1Ym1pdFRyYW5zYWN0aW9uIH0gZnJvbSAnLi4vZmFicmljJztcclxuXHJcbmNvbnN0IHsgT0ssIENSRUFURUQsIEJBRF9SRVFVRVNULCBOT1RfRk9VTkQsIElOVEVSTkFMX1NFUlZFUl9FUlJPUiB9ID0gU3RhdHVzQ29kZXM7XHJcblxyXG5leHBvcnQgY29uc3QgZG9uYXRpb25zUm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcclxuXHJcbi8qKlxyXG4gKiBHZXQgYWxsIGRvbmF0aW9uc1xyXG4gKi9cclxuZG9uYXRpb25zUm91dGVyLmdldCgnLycsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdHZXQgYWxsIGRvbmF0aW9ucyByZXF1ZXN0IHJlY2VpdmVkJyk7XHJcbiAgICBcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgY29udHJhY3QgPSByZXEuYXBwLmxvY2Fscy5jb250cmFjdCBhcyBDb250cmFjdDtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBldmFsdWF0ZVRyYW5zYWN0aW9uKGNvbnRyYWN0LCAnR2V0QWxsRG9uYXRpb25zJyk7XHJcbiAgICAgICAgY29uc3QgZG9uYXRpb25zID0gSlNPTi5wYXJzZShCdWZmZXIuZnJvbShyZXN1bHQpLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKE9LKS5qc29uKGRvbmF0aW9ucyk7XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2V0dGluZyBhbGwgZG9uYXRpb25zOicsIGVycm9yKTtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyhJTlRFUk5BTF9TRVJWRVJfRVJST1IpLmpzb24oe1xyXG4gICAgICAgICAgICBzdGF0dXM6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiBlcnJvcj8ubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcicsXHJcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSBhIG5ldyBkb25hdGlvblxyXG4gKi9cclxuZG9uYXRpb25zUm91dGVyLnBvc3QoXHJcbiAgICAnLycsXHJcbiAgICBbXHJcbiAgICAgICAgYm9keSgnaWQnKS5pc1N0cmluZygpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoJ0RvbmF0aW9uIElEIGlzIHJlcXVpcmVkJyksXHJcbiAgICAgICAgYm9keSgnZG9ub3JJRCcpLmlzU3RyaW5nKCkubm90RW1wdHkoKS53aXRoTWVzc2FnZSgnRG9ub3IgSUQgaXMgcmVxdWlyZWQnKSxcclxuICAgICAgICBib2R5KCdibG9vZFR5cGUnKS5pc1N0cmluZygpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoJ0Jsb29kIHR5cGUgaXMgcmVxdWlyZWQnKSxcclxuICAgICAgICBib2R5KCd0aW1lc3RhbXAnKS5pc1N0cmluZygpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoJ1RpbWVzdGFtcCBpcyByZXF1aXJlZCcpXHJcbiAgICBdLFxyXG4gICAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdDcmVhdGUgZG9uYXRpb24gcmVxdWVzdCByZWNlaXZlZDonLCByZXEuYm9keSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gVmFsaWRhdGUgcmVxdWVzdFxyXG4gICAgICAgIGNvbnN0IGVycm9ycyA9IHZhbGlkYXRpb25SZXN1bHQocmVxKTtcclxuICAgICAgICBpZiAoIWVycm9ycy5pc0VtcHR5KCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoQkFEX1JFUVVFU1QpLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnQmFkIFJlcXVlc3QnLFxyXG4gICAgICAgICAgICAgICAgZXJyb3JzOiBlcnJvcnMuYXJyYXkoKSxcclxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBjb250cmFjdCA9IHJlcS5hcHAubG9jYWxzLmNvbnRyYWN0IGFzIENvbnRyYWN0O1xyXG4gICAgICAgICAgICBjb25zdCB7IGlkLCBkb25vcklELCBibG9vZFR5cGUsIHRpbWVzdGFtcCB9ID0gcmVxLmJvZHk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBDaGVjayBpZiBkb25hdGlvbiBhbHJlYWR5IGV4aXN0c1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXhpc3RzUmVzdWx0ID0gYXdhaXQgZXZhbHVhdGVUcmFuc2FjdGlvbihjb250cmFjdCwgJ0RvbmF0aW9uRXhpc3RzJywgaWQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXhpc3RzID0gQnVmZmVyLmZyb20oZXhpc3RzUmVzdWx0KS50b1N0cmluZygpID09PSAndHJ1ZSc7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXhpc3RzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoQkFEX1JFUVVFU1QpLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICdCYWQgUmVxdWVzdCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBEb25hdGlvbiB3aXRoIElEICR7aWR9IGFscmVhZHkgZXhpc3RzYCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBjYXRjaCAoY2hlY2tFcnJvcjogYW55KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBjaGVja2luZyBpZiBkb25hdGlvbiBleGlzdHM6JywgY2hlY2tFcnJvcik7XHJcbiAgICAgICAgICAgICAgICAvLyBDb250aW51ZSBpZiBlcnJvciBvY2N1cnMgZHVyaW5nIGV4aXN0ZW5jZSBjaGVja1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBDcmVhdGUgdGhlIGRvbmF0aW9uXHJcbiAgICAgICAgICAgIGF3YWl0IHN1Ym1pdFRyYW5zYWN0aW9uKGNvbnRyYWN0LCAnQ3JlYXRlRG9uYXRpb24nLCBpZCwgZG9ub3JJRCwgYmxvb2RUeXBlLCB0aW1lc3RhbXApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoQ1JFQVRFRCkuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdDcmVhdGVkJyxcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdEb25hdGlvbiBjcmVhdGVkIHN1Y2Nlc3NmdWxseScsXHJcbiAgICAgICAgICAgICAgICBpZCxcclxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgY3JlYXRpbmcgZG9uYXRpb246JywgZXJyb3IpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyhJTlRFUk5BTF9TRVJWRVJfRVJST1IpLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnSW50ZXJuYWwgU2VydmVyIEVycm9yJyxcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yPy5tZXNzYWdlIHx8ICdVbmtub3duIGVycm9yJyxcclxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuKTtcclxuXHJcbi8qKlxyXG4gKiBHZXQgYSBzcGVjaWZpYyBkb25hdGlvbiBieSBJRFxyXG4gKi9cclxuZG9uYXRpb25zUm91dGVyLmdldChcclxuICAgICcvOmlkJyxcclxuICAgIFtcclxuICAgICAgICBwYXJhbSgnaWQnKS5pc1N0cmluZygpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoJ0RvbmF0aW9uIElEIGlzIHJlcXVpcmVkJylcclxuICAgIF0sXHJcbiAgICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYEdldCBkb25hdGlvbiByZXF1ZXN0IHJlY2VpdmVkIGZvciBJRDogJHtyZXEucGFyYW1zLmlkfWApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGVycm9ycyA9IHZhbGlkYXRpb25SZXN1bHQocmVxKTtcclxuICAgICAgICBpZiAoIWVycm9ycy5pc0VtcHR5KCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoQkFEX1JFUVVFU1QpLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnQmFkIFJlcXVlc3QnLFxyXG4gICAgICAgICAgICAgICAgZXJyb3JzOiBlcnJvcnMuYXJyYXkoKSxcclxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBjb250cmFjdCA9IHJlcS5hcHAubG9jYWxzLmNvbnRyYWN0IGFzIENvbnRyYWN0O1xyXG4gICAgICAgICAgICBjb25zdCBpZCA9IHJlcS5wYXJhbXMuaWQ7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXZhbHVhdGVUcmFuc2FjdGlvbihjb250cmFjdCwgJ1JlYWREb25hdGlvbicsIGlkKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRvbmF0aW9uID0gSlNPTi5wYXJzZShCdWZmZXIuZnJvbShyZXN1bHQpLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyhPSykuanNvbihkb25hdGlvbik7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKHJlYWRFcnJvcjogYW55KSB7XHJcbiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBkb25hdGlvbiBub3QgZm91bmRcclxuICAgICAgICAgICAgICAgIGlmIChyZWFkRXJyb3I/Lm1lc3NhZ2UgJiYgcmVhZEVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ2RvZXMgbm90IGV4aXN0JykpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyhOT1RfRk9VTkQpLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICdOb3QgRm91bmQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBgRG9uYXRpb24gd2l0aCBJRCAke2lkfSBub3QgZm91bmRgLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB0aHJvdyByZWFkRXJyb3I7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGdldHRpbmcgZG9uYXRpb24gd2l0aCBJRCAke3JlcS5wYXJhbXMuaWR9OmAsIGVycm9yKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHtcclxuICAgICAgICAgICAgICAgIHN0YXR1czogJ0ludGVybmFsIFNlcnZlciBFcnJvcicsXHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvcj8ubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcicsXHJcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbik7XHJcblxyXG4vKipcclxuICogVXBkYXRlIGRvbmF0aW9uIHN0YXR1c1xyXG4gKi9cclxuZG9uYXRpb25zUm91dGVyLnB1dChcclxuICAgICcvOmlkL3N0YXR1cycsXHJcbiAgICBbXHJcbiAgICAgICAgcGFyYW0oJ2lkJykuaXNTdHJpbmcoKS5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKCdEb25hdGlvbiBJRCBpcyByZXF1aXJlZCcpLFxyXG4gICAgICAgIGJvZHkoJ3N0YXR1cycpLmlzU3RyaW5nKCkubm90RW1wdHkoKS53aXRoTWVzc2FnZSgnU3RhdHVzIGlzIHJlcXVpcmVkJylcclxuICAgIF0sXHJcbiAgICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYFVwZGF0ZSBkb25hdGlvbiBzdGF0dXMgcmVxdWVzdCByZWNlaXZlZCBmb3IgSUQ6ICR7cmVxLnBhcmFtcy5pZH1gKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0KHJlcSk7XHJcbiAgICAgICAgaWYgKCFlcnJvcnMuaXNFbXB0eSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKEJBRF9SRVFVRVNUKS5qc29uKHtcclxuICAgICAgICAgICAgICAgIHN0YXR1czogJ0JhZCBSZXF1ZXN0JyxcclxuICAgICAgICAgICAgICAgIGVycm9yczogZXJyb3JzLmFycmF5KCksXHJcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgY29udHJhY3QgPSByZXEuYXBwLmxvY2Fscy5jb250cmFjdCBhcyBDb250cmFjdDtcclxuICAgICAgICAgICAgY29uc3QgaWQgPSByZXEucGFyYW1zLmlkO1xyXG4gICAgICAgICAgICBjb25zdCB7IHN0YXR1cyB9ID0gcmVxLmJvZHk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAvLyBDaGVjayBpZiBkb25hdGlvbiBleGlzdHMgZmlyc3RcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0c1Jlc3VsdCA9IGF3YWl0IGV2YWx1YXRlVHJhbnNhY3Rpb24oY29udHJhY3QsICdEb25hdGlvbkV4aXN0cycsIGlkKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0cyA9IEJ1ZmZlci5mcm9tKGV4aXN0c1Jlc3VsdCkudG9TdHJpbmcoKSA9PT0gJ3RydWUnO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFleGlzdHMpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyhOT1RfRk9VTkQpLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICdOb3QgRm91bmQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBgRG9uYXRpb24gd2l0aCBJRCAke2lkfSBub3QgZm91bmRgLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGNhdGNoIChjaGVja0Vycm9yOiBhbnkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIGlmIGRvbmF0aW9uIGV4aXN0czonLCBjaGVja0Vycm9yKTtcclxuICAgICAgICAgICAgICAgIC8vIENvbnRpbnVlIGlmIGVycm9yIG9jY3VycyBkdXJpbmcgZXhpc3RlbmNlIGNoZWNrXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIFVwZGF0ZSBkb25hdGlvbiBzdGF0dXNcclxuICAgICAgICAgICAgYXdhaXQgc3VibWl0VHJhbnNhY3Rpb24oY29udHJhY3QsICdVcGRhdGVEb25hdGlvblN0YXR1cycsIGlkLCBzdGF0dXMpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoT0spLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnT0snLFxyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYERvbmF0aW9uICR7aWR9IHN0YXR1cyB1cGRhdGVkIHRvICR7c3RhdHVzfWAsXHJcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIHVwZGF0aW5nIGRvbmF0aW9uIHN0YXR1cyBmb3IgSUQgJHtyZXEucGFyYW1zLmlkfTpgLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKElOVEVSTkFMX1NFUlZFUl9FUlJPUikuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InLFxyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3I/Lm1lc3NhZ2UgfHwgJ1Vua25vd24gZXJyb3InLFxyXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4pO1xyXG5cclxuLyoqXHJcbiAqIERlbGV0ZSBhIGRvbmF0aW9uXHJcbiAqL1xyXG5kb25hdGlvbnNSb3V0ZXIuZGVsZXRlKFxyXG4gICAgJy86aWQnLFxyXG4gICAgW1xyXG4gICAgICAgIHBhcmFtKCdpZCcpLmlzU3RyaW5nKCkubm90RW1wdHkoKS53aXRoTWVzc2FnZSgnRG9uYXRpb24gSUQgaXMgcmVxdWlyZWQnKVxyXG4gICAgXSxcclxuICAgIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhgRGVsZXRlIGRvbmF0aW9uIHJlcXVlc3QgcmVjZWl2ZWQgZm9yIElEOiAke3JlcS5wYXJhbXMuaWR9YCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGlvblJlc3VsdChyZXEpO1xyXG4gICAgICAgIGlmICghZXJyb3JzLmlzRW1wdHkoKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyhCQURfUkVRVUVTVCkuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdCYWQgUmVxdWVzdCcsXHJcbiAgICAgICAgICAgICAgICBlcnJvcnM6IGVycm9ycy5hcnJheSgpLFxyXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyYWN0ID0gcmVxLmFwcC5sb2NhbHMuY29udHJhY3QgYXMgQ29udHJhY3Q7XHJcbiAgICAgICAgICAgIGNvbnN0IGlkID0gcmVxLnBhcmFtcy5pZDtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIENoZWNrIGlmIGRvbmF0aW9uIGV4aXN0cyBmaXJzdFxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXhpc3RzUmVzdWx0ID0gYXdhaXQgZXZhbHVhdGVUcmFuc2FjdGlvbihjb250cmFjdCwgJ0RvbmF0aW9uRXhpc3RzJywgaWQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXhpc3RzID0gQnVmZmVyLmZyb20oZXhpc3RzUmVzdWx0KS50b1N0cmluZygpID09PSAndHJ1ZSc7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWV4aXN0cykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKE5PVF9GT1VORCkuanNvbih7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogJ05vdCBGb3VuZCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBEb25hdGlvbiB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGNoZWNrRXJyb3I6IGFueSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgY2hlY2tpbmcgaWYgZG9uYXRpb24gZXhpc3RzOicsIGNoZWNrRXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgLy8gQ29udGludWUgaWYgZXJyb3Igb2NjdXJzIGR1cmluZyBleGlzdGVuY2UgY2hlY2tcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gRGVsZXRlIHRoZSBkb25hdGlvblxyXG4gICAgICAgICAgICBhd2FpdCBzdWJtaXRUcmFuc2FjdGlvbihjb250cmFjdCwgJ0RlbGV0ZURvbmF0aW9uJywgaWQpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoT0spLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnT0snLFxyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYERvbmF0aW9uICR7aWR9IGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5YCxcclxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgZGVsZXRpbmcgZG9uYXRpb24gd2l0aCBJRCAke3JlcS5wYXJhbXMuaWR9OmAsIGVycm9yKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoSU5URVJOQUxfU0VSVkVSX0VSUk9SKS5qc29uKHtcclxuICAgICAgICAgICAgICAgIHN0YXR1czogJ0ludGVybmFsIFNlcnZlciBFcnJvcicsXHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvcj8ubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcicsXHJcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbik7XHJcblxyXG4vKipcclxuICogQ2hlY2sgaWYgYSBkb25hdGlvbiBleGlzdHNcclxuICovXHJcbmRvbmF0aW9uc1JvdXRlci5nZXQoXHJcbiAgICAnLzppZC9leGlzdHMnLFxyXG4gICAgW1xyXG4gICAgICAgIHBhcmFtKCdpZCcpLmlzU3RyaW5nKCkubm90RW1wdHkoKS53aXRoTWVzc2FnZSgnRG9uYXRpb24gSUQgaXMgcmVxdWlyZWQnKVxyXG4gICAgXSxcclxuICAgIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhgQ2hlY2sgZG9uYXRpb24gZXhpc3RzIHJlcXVlc3QgcmVjZWl2ZWQgZm9yIElEOiAke3JlcS5wYXJhbXMuaWR9YCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGlvblJlc3VsdChyZXEpO1xyXG4gICAgICAgIGlmICghZXJyb3JzLmlzRW1wdHkoKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyhCQURfUkVRVUVTVCkuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdCYWQgUmVxdWVzdCcsXHJcbiAgICAgICAgICAgICAgICBlcnJvcnM6IGVycm9ycy5hcnJheSgpLFxyXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyYWN0ID0gcmVxLmFwcC5sb2NhbHMuY29udHJhY3QgYXMgQ29udHJhY3Q7XHJcbiAgICAgICAgICAgIGNvbnN0IGlkID0gcmVxLnBhcmFtcy5pZDtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0c1Jlc3VsdCA9IGF3YWl0IGV2YWx1YXRlVHJhbnNhY3Rpb24oY29udHJhY3QsICdEb25hdGlvbkV4aXN0cycsIGlkKTtcclxuICAgICAgICAgICAgY29uc3QgZXhpc3RzID0gQnVmZmVyLmZyb20oZXhpc3RzUmVzdWx0KS50b1N0cmluZygpID09PSAndHJ1ZSc7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyhPSykuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdPSycsXHJcbiAgICAgICAgICAgICAgICBleGlzdHMsXHJcbiAgICAgICAgICAgICAgICBpZCxcclxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgY2hlY2tpbmcgaWYgZG9uYXRpb24gZXhpc3RzIHdpdGggSUQgJHtyZXEucGFyYW1zLmlkfTpgLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKElOVEVSTkFMX1NFUlZFUl9FUlJPUikuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InLFxyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3I/Lm1lc3NhZ2UgfHwgJ1Vua25vd24gZXJyb3InLFxyXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4pOyAiXX0=